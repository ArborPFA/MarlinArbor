<!-- ArborPFA settings xml file -->

<pandora>
    <!-- GLOBAL SETTINGS -->
    <IsMonitoringEnabled>true</IsMonitoringEnabled>
    <ShouldDisplayAlgorithmInfo>true</ShouldDisplayAlgorithmInfo>
    <ShouldCollapseMCParticlesToPfoTarget>false</ShouldCollapseMCParticlesToPfoTarget>

    <!-- PLUGIN SETTINGS -->
    <HadronicEnergyCorrectionPlugins> SdhcalQuadraticEnergyFunction </HadronicEnergyCorrectionPlugins>
    <ElectromagneticEnergyCorrectionPlugins> SdhcalQuadraticEnergyFunction </ElectromagneticEnergyCorrectionPlugins>
    
<!--     <EmShowerPlugin>ArborEmShowerId</EmShowerPlugin>
    <PhotonPlugin>ArborPhotonId</PhotonPlugin>
    <ElectronPlugin>ArborElectronId</ElectronPlugin>
    <MuonPlugin>ArborMuonId</MuonPlugin> -->
    
    <SdhcalQuadraticEnergyFunction>
        <EnergyConstantParameters>
            0.0275562;
            2.48209e-05;
            -2.0772e-08;
            0.100251;
            2.07212e-05;
            -2.99901e-08;
            0.181102;
            5.88835e-05;
            8.31624e-08; 
        </EnergyConstantParameters>
        <SdhcalThresholds>
            0.0400452 
            0.101322 
            0.39448
        </SdhcalThresholds>
    </SdhcalQuadraticEnergyFunction>
    

    <!-- ALGORITHM SETTINGS -->
    <!-- Configure all algorithms here without running them -->
    <algorithm type = "AlgorithmConfiguration">
        <algorithms>
        
            <!-- Configure a visual monitoring displaying the current cluster list to run between each step -->
            <algorithm type = "VisualMonitoring" instance="MonitoringClusters">
               <ShowCurrentConnectors>true</ShowCurrentConnectors>
               <ConnectorLevel>Clusters</ConnectorLevel>
               <ShowCurrentMCParticles>false</ShowCurrentMCParticles>
               <ShowCurrentCaloHits>false</ShowCurrentCaloHits>
               <ShowCurrentTracks>false</ShowCurrentTracks>
               <ShowCurrentClusters>true</ShowCurrentClusters>
               <ShowCurrentPfos>false</ShowCurrentPfos>
               <ShowCurrentVertices>false</ShowCurrentVertices>      
               <HitColors>iterate</HitColors>
               <DisplayEvent>false</DisplayEvent>
               <ShowDetector>true</ShowDetector>
               <DetectorView>""</DetectorView>
               <ShowOnlyAvailable>false</ShowOnlyAvailable>
               <ShowAssociatedTracks>true</ShowAssociatedTracks>
            </algorithm>
        
	        <!-- Main clustering algorithm with optimized parameters -->
	        <algorithm type = "ArborClustering" instance = "ClusteringOptimized">
	           <ECalConnectionTools>
	               <tool type = "ConnectorSeeding" />
	               <tool type = "ConnectorCleaning" />
	           </ECalConnectionTools>
               <HCalConnectionTools>
                   <tool type = "ConnectorSeeding" />
                   <tool type = "ConnectorCleaning" />
               </HCalConnectionTools>
               <MuonConnectionTools>
                <!-- TODO write a muon connection tool -->
               </MuonConnectionTools>
               <AdditionalConnectionTools>
                   <tool type = "GapCrossingConnection" >
                       <HCalRingDetectorName>HCalRing</HCalRingDetectorName>
                   </tool>
               </AdditionalConnectionTools>
            </algorithm>
	        
	        <!-- Topological association parent algorithm with optimized parameters -->
	        <algorithm type = "TopologicalAssociationParent" instance = "AssociationOptimized">
	            <associationAlgorithms>
					<algorithm type = "TopologicalTrackClusterAssociation">
						<TrackClusterNLayersCut> 4 </TrackClusterNLayersCut>
						<MaxNormaleAngle> 0.8f </MaxNormaleAngle>
						<MaxTransverseAngle> 0.7f </MaxTransverseAngle>
						<MaxNormaleDistance> 20.f </MaxNormaleDistance>
						<MaxTransverseDistance> 30.f </MaxTransverseDistance>
					</algorithm>
					<algorithm type = "ClosebySeedMerging" />
					<algorithm type = "ClusterFragmentMerging">
						<MinNCaloHits>5</MinNCaloHits>
						<MinNPseudoLayers>4</MinNPseudoLayers>
						<MinNHitPerLayer>0.8f</MinNHitPerLayer>
						<MaxFirstPseudoLayerFit>5</MaxFirstPseudoLayerFit>
						<MaxClusterDistance>150.f</MaxClusterDistance>
						<MaxFitPseudoLayer>4</MaxFitPseudoLayer>
						<MaxClusterFitAngle>0.261</MaxClusterFitAngle>
						<MaxClusterFitAngle2>0.261</MaxClusterFitAngle2>
						<MaxEnergyChi2>1.f</MaxEnergyChi2>
					</algorithm>
					<algorithm type = "CloudClusterRemoval">
						<MaxCloudClusterEnergy>1.f</MaxCloudClusterEnergy>
						<MaxClusterNHit>10</MaxClusterNHit>
						<MinClusterExtension>0.5</MinClusterExtension>
					</algorithm>
                    <algorithm type = "ContactClusterMerging">
						<MaxClusterDistance>50.f</MaxClusterDistance>
						<MinClusterContactDistance>10.f</MinClusterContactDistance>
						<MinNHitContact>5</MinNHitContact>
						<MaxEnergyChi2>1.f</MaxEnergyChi2>
                    </algorithm>
					<algorithm type = "SurroundingHitsMerging">
						<MaxAssociationDistance>100.f</MaxAssociationDistance>
						<EnergyWeight>0.f</EnergyWeight>
						<DistanceWeight>1.f</DistanceWeight>
					</algorithm>
	            </associationAlgorithms>
	        </algorithm>
	        
	        
	        <!-- Reclustering algorithms -->
	        <algorithm type = "ArborClustering" instance = "Reclustering1">
               <ECalConnectionTools>
                   <tool type = "ConnectorSeeding">
                       <MaxNormaleDistanceFine> 17.f </MaxNormaleDistanceFine>
                       <MaxTransverseDistanceFine> 32.f </MaxTransverseDistanceFine>
                       <MaxConnectionAngleFine>0.8</MaxConnectionAngleFine>
                   </tool>
                   <tool type = "ConnectorCleaning" />
               </ECalConnectionTools>
               <HCalConnectionTools>
                   <tool type = "ConnectorSeeding">
                       <MaxNormaleDistanceCoarse> 60.f </MaxNormaleDistanceCoarse>
                       <MaxTransverseDistanceCoarse> 90.f </MaxTransverseDistanceCoarse>
                       <MaxConnectionAngleCoarse>0.75</MaxConnectionAngleCoarse>
                   </tool>
                   <tool type = "ConnectorCleaning" />
               </HCalConnectionTools>
               <MuonConnectionTools>
               </MuonConnectionTools>
               <AdditionalConnectionTools>
                   <tool type = "GapCrossingConnection" >
                       <HCalRingDetectorName>HCalRing</HCalRingDetectorName>
                   </tool>
               </AdditionalConnectionTools>
            </algorithm>
            
            <algorithm type = "ArborClustering" instance = "Reclustering2">
               <ECalConnectionTools>
                   <tool type = "ConnectorSeeding">
                       <MaxNormaleDistanceFine> 14.f </MaxNormaleDistanceFine>
                       <MaxTransverseDistanceFine> 29.f </MaxTransverseDistanceFine>
                       <MaxConnectionAngleFine>0.7</MaxConnectionAngleFine>
                   </tool>
                   <tool type = "ConnectorCleaning" />
               </ECalConnectionTools>
               <HCalConnectionTools>
                   <tool type = "ConnectorSeeding">
                       <MaxNormaleDistanceCoarse> 55.f </MaxNormaleDistanceCoarse>
                       <MaxTransverseDistanceCoarse> 70.f </MaxTransverseDistanceCoarse>
                       <MaxConnectionAngleCoarse>0.7</MaxConnectionAngleCoarse>
                   </tool>
                   <tool type = "ConnectorCleaning" />
               </HCalConnectionTools>
               <MuonConnectionTools>
               </MuonConnectionTools>
               <AdditionalConnectionTools>
                   <tool type = "GapCrossingConnection">
                       <HCalRingDetectorName>HCalRing</HCalRingDetectorName>
                   </tool>
               </AdditionalConnectionTools>
            </algorithm>
            
            <algorithm type = "ArborClustering" instance = "Reclustering3">
               <ECalConnectionTools>
                   <tool type = "ConnectorSeeding">
                       <MaxPseudoLayerConnection>3</MaxPseudoLayerConnection>
                       <MaxNormaleDistanceFine> 12.f </MaxNormaleDistanceFine>
                       <MaxTransverseDistanceFine> 25.f </MaxTransverseDistanceFine>
                       <MaxConnectionAngleFine>0.65</MaxConnectionAngleFine>
                   </tool>
                   <tool type = "ConnectorCleaning" />
               </ECalConnectionTools>
               <HCalConnectionTools>
                   <tool type = "ConnectorSeeding">
                       <MaxPseudoLayerConnection>3</MaxPseudoLayerConnection>
                       <MaxNormaleDistanceCoarse> 50.f </MaxNormaleDistanceCoarse>
                       <MaxTransverseDistanceCoarse> 65.f </MaxTransverseDistanceCoarse>
                       <MaxConnectionAngleCoarse>0.65</MaxConnectionAngleCoarse>
                   </tool>
                   <tool type = "ConnectorCleaning" />
               </HCalConnectionTools>
               <MuonConnectionTools>
               </MuonConnectionTools>
               <AdditionalConnectionTools>
                   <tool type = "GapCrossingConnection">
                       <HCalRingDetectorName>HCalRing</HCalRingDetectorName>
                   </tool>
               </AdditionalConnectionTools>
            </algorithm>
        </algorithms>
    </algorithm>
    




    <!-- Select tracks and hits to use for clustering -->
    <algorithm type = "EventPreparation">
        <OutputTrackListName>Tracks</OutputTrackListName>
        <MergeECalHCalCaloHitLists>true</MergeECalHCalCaloHitLists>
        <OutputCaloHitListName>CaloHits</OutputCaloHitListName>
        <OutputMuonCaloHitListName>MuonYokeHits</OutputMuonCaloHitListName>
        <ReplacementTrackListName>Tracks</ReplacementTrackListName>
        <ReplacementCaloHitListName>CaloHits</ReplacementCaloHitListName>
    </algorithm>

    <!-- Run first clustering algorithm ad its topological associations with optimized parameters -->
    <algorithm type = "ClusteringParent">
        <algorithm type = "ArborClustering" description = "ClusterFormation" instance = "ClusteringOptimized" />
        <algorithm type = "TopologicalAssociationParent" description = "ClusterAssociation" instance = "AssociationOptimized" />
        <ClusterListName>PrimaryTrees</ClusterListName>
        <ReplaceCurrentClusterList>true</ReplaceCurrentClusterList>
    </algorithm>
    
    <!-- Run reclustering on charged clusters that do not match the track energy, using different strategies -->
    
    <!-- Run reclustering on clusters with neutrals particles in its vicinity -->
    <algorithm type = "NeutralVicinityReclustering">
         <clusteringAlgorithms>
            <algorithm type = "ArborClustering" instance = "Reclustering1" />
            <algorithm type = "ArborClustering" instance = "Reclustering2" />
            <algorithm type = "ArborClustering" instance = "Reclustering3" />
         </clusteringAlgorithms>
         <algorithm type = "TopologicalAssociationParent" description = "ClusterAssociation" instance = "AssociationOptimized" />
         <!-- <algorithm type = "VisualMonitoring" description = "Monitoring" instance="MonitoringClusters" /> -->
         <MinChi2ToRunReclustering>2.5f</MinChi2ToRunReclustering>
         <MaxChi2ToStopReclustering>0.8f</MaxChi2ToStopReclustering>
    </algorithm>
    
    
    <!-- Prepare tracks for particle flow objects -->
    <algorithm type = "TrackPreparation">
        <CandidateListNames>Tracks</CandidateListNames>
        <MergedCandidateListName>PfoCandidates</MergedCandidateListName>
        <PfoTrackListName>PfoCreation</PfoTrackListName>
        <ShouldMakeAssociations>false</ShouldMakeAssociations>
    </algorithm>
    
    <!-- Prepare clusters for particle flow objects -->
    <algorithm type = "ClusterPreparation">
        <CandidateListNames>PrimaryTrees</CandidateListNames>
        <MergedCandidateListName>PfoCreation</MergedCandidateListName>
    </algorithm>
    
     <!-- Create particle flow objects -->
     <algorithm type = "PfoCreation">
       <OutputPfoListName> ArborPfos </OutputPfoListName>
       <ShouldCreateTrackBasedPfos> true </ShouldCreateTrackBasedPfos>
       <ShouldCreateNeutralPfos> true </ShouldCreateNeutralPfos>
       <MinClusterElectromagneticEnergy> 0.1 </MinClusterElectromagneticEnergy>
       <MinClusterHadronicEnergy>0.1</MinClusterHadronicEnergy>
       <AllowSingleLayerClusters> true </AllowSingleLayerClusters>
       <MinHitsInCluster>1</MinHitsInCluster>
     </algorithm>
     
     <!-- Open Eve visual monitoring-->
     <algorithm type = "VisualMonitoring">
        <ShowCurrentConnectors>true</ShowCurrentConnectors>
        <ConnectorLevel>Pfos</ConnectorLevel>
        
        <ShowCurrentMCParticles>false</ShowCurrentMCParticles>
        <ShowCurrentCaloHits>true</ShowCurrentCaloHits>
        <ShowCurrentTracks>false</ShowCurrentTracks>
        <ShowCurrentClusters>false</ShowCurrentClusters>
        <ShowCurrentPfos>true</ShowCurrentPfos>
        <ShowCurrentVertices>false</ShowCurrentVertices>      
        
        <HitColors>iterate</HitColors>
        <DisplayEvent>true</DisplayEvent>
        <ShowDetector>true</ShowDetector>
        <DetectorView>""</DetectorView>
        <ShowOnlyAvailable>false</ShowOnlyAvailable>
        <ShowAssociatedTracks>true</ShowAssociatedTracks>
     </algorithm>
     
</pandora>
